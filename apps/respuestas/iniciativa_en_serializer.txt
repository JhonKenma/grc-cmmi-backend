# ============================================
# SERIALIZERS DE INICIATIVAS
# ============================================

class IniciativaListSerializer(serializers.ModelSerializer):
    """Serializer simplificado para listados"""
    
    dimension_nombre = serializers.CharField(source='dimension.nombre', read_only=True)
    empresa_nombre = serializers.CharField(source='empresa.nombre', read_only=True)
    responsable_nombre = serializers.CharField(
        source='responsable.nombre_completo',
        read_only=True
    )
    estado_display = serializers.CharField(source='get_estado_display', read_only=True)
    prioridad_display = serializers.CharField(source='get_prioridad_display', read_only=True)
    dias_restantes = serializers.SerializerMethodField()
    
    class Meta:
        model = Iniciativa
        fields = [
            'id', 'titulo', 'dimension', 'dimension_nombre',
            'empresa', 'empresa_nombre', 'responsable', 'responsable_nombre',
            'estado', 'estado_display', 'prioridad', 'prioridad_display',
            'fecha_inicio_estimada', 'fecha_termino_estimada',
            'porcentaje_avance', 'dias_restantes'
        ]
    
    def get_dias_restantes(self, obj):
        return obj.dias_restantes


class IniciativaDetailSerializer(serializers.ModelSerializer):
    """Serializer detallado de iniciativas"""
    
    calculo_nivel = CalculoNivelSerializer(read_only=True)
    dimension_nombre = serializers.CharField(source='dimension.nombre', read_only=True)
    empresa_nombre = serializers.CharField(source='empresa.nombre', read_only=True)
    responsable_nombre = serializers.CharField(
        source='responsable.nombre_completo',
        read_only=True
    )
    asignado_por_nombre = serializers.CharField(
        source='asignado_por.nombre_completo',
        read_only=True
    )
    estado_display = serializers.CharField(source='get_estado_display', read_only=True)
    prioridad_display = serializers.CharField(source='get_prioridad_display', read_only=True)
    dias_restantes = serializers.SerializerMethodField()
    requiere_alerta = serializers.SerializerMethodField()
    
    class Meta:
        model = Iniciativa
        fields = '__all__'
    
    def get_dias_restantes(self, obj):
        return obj.dias_restantes
    
    def get_requiere_alerta(self, obj):
        return obj.requiere_alerta


class IniciativaCreateSerializer(serializers.ModelSerializer):
    """Serializer para crear iniciativas"""
    
    class Meta:
        model = Iniciativa
        fields = [
            'calculo_nivel', 'dimension', 'empresa',
            'titulo', 'descripcion', 'objetivo',
            'prioridad', 'responsable',
            'fecha_inicio_estimada', 'fecha_termino_estimada',
            'presupuesto_estimado', 'moneda', 'dias_alerta_previo'
        ]
    
    def create(self, validated_data):
        """Crear iniciativa con auditor√≠a"""
        request = self.context.get('request')
        
        if request and request.user:
            validated_data['asignado_por'] = request.user
        
        return super().create(validated_data)